# Vietcong Match Parser

This PHP script processes match result files generated by the Vietcong game server, extracts relevant match and player data, and sends it to a public API for further processing and storage.

## Features

1. **File Parsing:** Scans a directory (e.g., `mpresults/`) for result files matching a specific pattern (e.g., `endresults-YYYY-MM-DD_HH-mm-ss.txt`).
2. **Validation:** Ensures each file contains valid match results (e.g., "Map end rule: 00:00", at least 3 players from same clan in a team and so on).
3. **Data Extraction:**
   - Match details: map name, date, time, mode, and team points.
   - Player stats: kills, deaths, points, and kill/death ratio.
4. **Team Identification:** Identifies consistent clan tags for US and VC teams based on player names.
5. **JSON Payload:** Builds a JSON payload with the parsed data.
6. **API Integration:** (Optional) Sends the payload to a public API endpoint.
7. **Tracking:** Allows tracking processed files to avoid reprocessing.

## Configuration

All configurations can be modified within the script:

- `server_name`: Name of the server collecting the match results (e.g., `'*RC* Warserver 1'`).
- `tag`: A tag to identify the matches collected (e.g., `'LIGA-Q1-2025'`).
- `allowed_modes`: Allowed game modes (e.g., `["CTF", "ATG"]`).
- `directory`: Directory containing the match result files (default: `__DIR__ . '/mpresults'`).
- `onlyToday`: Set to `true` to process only today's files. Recomemnded for lowering API load if the script is called by CRON once every X minutes/hours in a day.
- `apiEndpoint`: URL of the API endpoint to send the processed JSON payload.
- `minTagMatches`: Minimum number of players sharing a clan tag for identification (default: `3`).

## Návod na instalaci a automatické spouštění collectoru každých 5 minut

_(english version below)_

### Krok 1: Instalace PHP přes Chocolatey (snadný způsob)

1. Stáhněte si a nainstalujte [Chocolatey](https://chocolatey.org/install).
   - Otevřete **PowerShell** s právy administrátora a spusťte:
     ```Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))```

2. Nainstalujte PHP jednoduše příkazem:
   ```cmd
   choco install php
   ```

3. Zkontrolujte instalaci:
   ```cmd
   php -v
   ```

### Krok 2: Zapněte nutné PHP knihovny

1. Identifikujte váš php.ini soubor pomocí
   ```cmd
   php -i | findstr "Loaded Configuration File"
   ```

2. Zapněte curl, mbstring a exif knihovny odebráním ; jako:
   ```cmd
   extension=curl
   extension=mbstring
   extension=exif
   ```

### Krok 3: Doplňte potřebné PHP certifikáty

- Stáhněte soubor CA bundle z [curl's CA Extract](https://curl.se/docs/caextract.html).
- Uložte soubor jako `cacert.pem` na známé místo, např. `C:\php\extras\ssl\cacert.pem` na Windows.
- Otevřete konfigurační soubor PHP (`php.ini`).
- Najděte nebo přidejte následující řádky:
  ```ini
  curl.cainfo = "C:\path\to\cacert.pem"
  openssl.cafile = "C:\path\to\cacert.pem"
  ```
  Nahraďte `"C:\path\to\cacert.pem"` plnou cestou ke staženému souboru `cacert.pem`.

### Krok 4: Přesuňte soubory do složky s Vietcongem

Přesuňte soubory `collector.php` a `collector_cron.bat` do složky s Vietcongem.
Výsledkem by mělo být, že oba soubory budou ve stejné složce s Vietcongem, kde je i složka **mpresults**.

### Krok 5: Nastavení opakovaného spouštění pomocí `schtasks`

1. Spusťte **CMD** jako administrátor a přidejte úkol takto:

   ```cmd
   schtasks /create /sc minute /mo 5 /tn "VietcongHubMpresultsCollector" /tr "C:\Server\Vietcong\collector_cron.bat" /ru SYSTEM
   ```

   - `/sc minute` spouští úlohu každých 5 minut.
   - `/tn "VietcongHubMpresultsCollector"` je název úlohy.
   - `/tr` určuje cestu k vašemu `.bat` souboru.
   - `/ru SYSTEM` zajistí, že se úloha spustí i bez přihlášení.

### Krok 6: Kontrola naplánované úlohy

Zkontrolujte vytvořenou úlohu příkazem:
```cmd
schtasks /query /tn "VietcongHubMpresultsCollector"
```

### Jak to funguje?

1. Při startu systému a každých 5 minut Windows spustí `.bat` soubor.
2. `.bat` soubor zavolá PHP collector v aktuálním adresáři.

### Jak odstranit naplánovanou úlohu?

Pokud chcete úlohu smazat, použijte:
```cmd
schtasks /delete /tn "VietcongHubMpresultsCollector" /f
```

## Install Guide with Setting Up CRON Every 5 Minutes on Windows

### Step 1: Install PHP Using Chocolatey (Easy Method)

1. Download and install [Chocolatey](https://chocolatey.org/install).
   - Open **PowerShell** with administrator privileges and run the following command:
     ```Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))```

2. Install PHP easily using Chocolatey:
   ```cmd
   choco install php
   ```

3. Verify the PHP installation:
   ```cmd
   php -v
   ```

### Step 2: Enable Required PHP Extensions

1. Locate your php.ini file using
   ```cmd
   php -i | findstr "Loaded Configuration File"
   ```

2. Enable curl, mbstring and exif extensions by removing ; like so:
   ```cmd
   extension=curl
   extension=mbstring
   extension=exif
   ```

### Step 3: Configuring PHP Certificates

- A CA bundle contains trusted certificates used to verify SSL connections.
- Download the CA bundle file from [curl's CA Extract](https://curl.se/docs/caextract.html).
- Save the file as `cacert.pem` in a known location, e.g., `C:\php\extras\ssl\cacert.pem` on Windows.

- Open your PHP configuration file (`php.ini`).
- Locate or add the following lines:
  ```ini
  curl.cainfo = "C:\path\to\cacert.pem"
  openssl.cafile = "C:\path\to\cacert.pem"
  ```
  Replace `"C:\path\to\cacert.pem"` with the full path to your downloaded `cacert.pem` file.


### Step 4: Move files to the Vietcong folder

Move files `collector.php` and `collector_cron.bat` in the Vietcong game folder.
Result should be so that both files are in the same Vietcong game folder as **mpresults** folder.

### Step 5: Set Up Scheduled Execution Using `schtasks`

1. Open **Command Prompt (CMD)** as an administrator and create a scheduled task:

   ```cmd
   schtasks /create /sc minute /mo 5 /tn "VietcongHubMpresultsCollector" /tr "C:\Server\Vietcong\collector_cron.bat" /ru SYSTEM
   ```

   - `/sc minute` schedules the task to run every 5 minutes.
   - `/tn "VietcongHubMpresultsCollector"` sets the name of the task.
   - `/tr` specifies the path to your `.bat` file.
   - `/ru SYSTEM` ensures the task runs even without a user logged in.

### Step 6: Verify the Scheduled Task

Check the created task using the following command:
```cmd
schtasks /query /tn "VietcongHubMpresultsCollector"
```


### How It Works

1. At system startup and every 5 minutes thereafter, Windows runs the `.bat` file.
2. The `.bat` file calls the PHP script in the current directory.

### How to Delete the Scheduled Task

If you want to delete the task, use this command:
```cmd
schtasks /delete /tn "VietcongHubMpresultsCollector" /f
```

## How the Collector Works

1. **Locate Files:**
   - Scans the specified directory for files matching the naming pattern.

2. **Validate Files:**
   - Ensures files contain valid match results with the "Map end rule: 00:00" marker.

3. **Parse Data:**
   - Extracts match details, including map, date, time, and team points.
   - Extracts player statistics: points, kills, deaths, and kill/death ratio.

4. **Identify Clan Tags:**
   - Analyzes player names to determine consistent clan tags for US and VC teams.

5. **Generate Payload:**
   - Creates a JSON payload containing match and player data.

6. **Send Data:**
   - (Optional) Sends the JSON payload to the specified API endpoint.

## Example JSON Payload

```json
{
  "hash": "abc123",
  "file": "endresults-2024-12-18_20-30-00.txt",
  "tag": "LIGA-Q1-2025",
  "server_name": "*RC* Warserver 1",
  "match": {
    "map": "NVA Base",
    "mode": "CTF",
    "date": "2024-12-18",
    "time": "20:30:00",
    "points_us": 10,
    "points_vc": 8,
    "team_us": "USClan",
    "team_vc": "VCClan"
  },
  "players_us": {
    "Player1": {
      "points": 15,
      "kills": 10,
      "deaths": 5,
      "k_d": 2.0
    },
    "Player2": {
      "points": 8,
      "kills": 5,
      "deaths": 3,
      "k_d": 1.6667
    }
  },
  "players_vc": {
    "PlayerA": {
      "points": 12,
      "kills": 8,
      "deaths": 6,
      "k_d": 1.3333
    },
    "PlayerB": {
      "points": 6,
      "kills": 3,
      "deaths": 4,
      "k_d": 0.75
    }
  }
}
